<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Admin Dashboard - eCitizen</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
   <link rel="stylesheet" href="../css/admin.css"> 
   <style>
       .stat-card {
         background: white;
         border-radius: 12px;
         padding: 1.5rem;
         box-shadow: 0 2px 10px rgba(0,0,0,0.03);
         display: flex;
         align-items: center;
         justify-content: space-between;
         height: 100%;
         border: 1px solid #eef0f7;
      }
      .stat-icon {
         width: 50px;
         height: 50px;
         border-radius: 10px;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 1.5rem;
         color: white;
      }
      .bg-pending { background: #f39c12; }
      .bg-approved { background: #27ae60; }
      .bg-rejected { background: #e74c3c; }
      .bg-total { background: #3498db; }

       .table-card {
         background: white;
         border-radius: 12px;
         box-shadow: 0 2px 10px rgba(0,0,0,0.03);
         border: 1px solid #eef0f7;
         overflow: hidden;
         margin-top: 2rem;
      }
      
      .status-badge {
         padding: 0.35rem 0.75rem;
         border-radius: 6px;
         font-size: 0.8rem;
         font-weight: 600;
         letter-spacing: 0.5px;
      }
      .status-pending { background: #fff8e1; color: #f39c12; }
      .status-approved { background: #e8f5e9; color: #27ae60; }
      .status-rejected { background: #ffebee; color: #e74c3c; }

      /* Modal Styles */
       .doc-card {
         background: #f8f9fa;
         border: 1px solid #e9ecef;
         border-radius: 8px;
         padding: 1rem;
         margin-bottom: 0.75rem;
         display: flex;
         align-items: center;
         justify-content: space-between;
      }
      .detail-label { font-size: 0.75rem; text-transform: uppercase; color: #7f8c8d; font-weight: 700; }
      .detail-value { font-size: 0.95rem; color: #2c3e50; font-weight: 500; margin-bottom: 1rem;}
   </style>
</head>
<body>
   <div class="admin-wrapper">
       <div id="content">
            <!-- Main Container -->
            <div class="main-container">
                <div class="page-header">
                    <h2 class="page-title">Dashboard Overview</h2>
                    <p class="page-breadcrumb">Welcome back, get an overview of recent applications.</p>
                </div>

      <div class="row g-4 mb-4">
         <div class="col-md-3">
            <div class="stat-card">
               <div>
                  <h6 class="text-muted mb-1">Total Applications</h6>
                  <h3 class="mb-0" id="totalCount">0</h3>
               </div>
               <div class="stat-icon bg-total">
                  <i class="bi bi-folder2-open"></i>
               </div>
            </div>
         </div>
         <div class="col-md-3">
            <div class="stat-card">
               <div>
                  <h6 class="text-muted mb-1">Pending</h6>
                  <h3 class="mb-0" id="pendingCount">0</h3>
               </div>
               <div class="stat-icon bg-pending">
                  <i class="bi bi-hourglass-split"></i>
               </div>
            </div>
         </div>
         <div class="col-md-3">
            <div class="stat-card">
               <div>
                  <h6 class="text-muted mb-1">Approved</h6>
                  <h3 class="mb-0" id="approvedCount">0</h3>
               </div>
               <div class="stat-icon bg-approved">
                  <i class="bi bi-check-lg"></i>
               </div>
            </div>
         </div>
         <div class="col-md-3">
            <div class="stat-card">
               <div>
                  <h6 class="text-muted mb-1">Rejected</h6>
                  <h3 class="mb-0" id="rejectedCount">0</h3>
               </div>
               <div class="stat-icon bg-rejected">
                  <i class="bi bi-x-lg"></i>
               </div>
            </div>
         </div>
      </div>
      
      <!-- Search Bar -->
      <div class="mb-4">
        <div class="input-group" style="max-width: 500px;">
          <input type="text" class="form-control" id="searchInput" placeholder="Search by NID, name, email, phone..." oninput="debounceSearch()">
          <button class="btn btn-primary" onclick="searchCitizens()">
            <i class="bi bi-search"></i> Search
          </button>
          <button class="btn btn-outline-secondary" onclick="clearSearch()">Clear</button>
        </div>
      </div>
      
      <!-- Applications Table -->
      <div class="table-card">
        <div class="table-header d-flex justify-content-between align-items-center p-3 border-bottom">
          <h5 class="card-title mb-0">Recent Applications</h5>
          <button class="btn btn-sm btn-outline-primary" onclick="loadApplications()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
          </button>
        </div>
         <div class="table-responsive">
            <table class="table table-hover mb-0">
               <thead class="table-light">
                  <tr>
                     <th class="ps-4">Name</th>
                     <th>Email</th>
                     <th>Applied Date</th>
                     <th>Status</th>
                     <th>Actions</th>
                  </tr>
               </thead>
               <tbody id="applicationsTableBody">
                  <tr>
                     <td colspan="5" class="text-center py-4">Loading applications...</td>
                  </tr>
               </tbody>
            </table>
         </div>
            </div>
       </div>
   </div>

   <!-- Application Details Modal-->
   <div class="modal fade" id="detailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
         <div class="modal-content">
          <div class="modal-header bg-primary text-white">
             <h5 class="modal-title"><i class="bi bi-person-badge me-2"></i>Application Details</h5>
             <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-4" id="modalBody" style="background: #f8f9fa;">
             <!-- Content loaded dynamically with modern card layout -->
             <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                   <span class="visually-hidden">Loading...</span>
                </div>
             </div>
          </div>
          <div class="modal-footer bg-light border-0">
             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-1"></i>Close
             </button>
             <button type="button" class="btn btn-danger" id="rejectBtn">
                <i class="bi bi-x-lg me-1"></i>Reject Application
             </button>
             <button type="button" class="btn btn-success" id="approveBtn">
                <i class="bi bi-check-lg me-1"></i>Approve Application
             </button>
            </div>
         </div>
      </div>
   </div>

   <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
   <script src="../js/admin_common.js"></script> 
   <script>
      
       let currentApplicationId = null;

       $(document).ready(function() {
          checkAuth();
          loadApplications();

          $('#approveBtn').click(() => approveWithNID(currentApplicationId));
          $('#rejectBtn').click(() => updateStatus(currentApplicationId, 'rejected'));
       });

       function checkAuth() {
          const token = localStorage.getItem('token');
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          
          if (!token || user.role !== 'admin') {
             window.location.href = '../pages/login.html';
             return;
          }
       }

      async function loadApplications() {
         try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/citizens', {
               headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            
            if (response.ok) {
               renderTable(data.data);
               updateStats(data.data);
            } else {
               alert('Failed to load applications');
            }
         } catch (error) {
            console.error('Error:', error);
         }
      }

      function renderTable(applications) {
         const tbody = $('#applicationsTableBody');
         tbody.empty();
         
         if (applications.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center py-4">No applications found</td></tr>');
            return;
         }
         
         applications.forEach(app => {
            const statusClass = `status-${app.applicationStatus}`;
            const date = new Date(app.createdAt).toLocaleDateString();
            
            const userName = app.user ? app.user.fullName : '<span class="text-muted"><em>Unknown/Deleted</em></span>';
            const userEmail = app.user ? app.user.email : 'N/A';
            
            const row = `
               <tr>
                  <td class="ps-4 fw-medium">${userName}</td>
                  <td>${userEmail}</td>
                  <td>${date}</td>
                  <td><span class="status-badge ${statusClass}">${app.applicationStatus.toUpperCase()}</span></td>
                  <td>
                     <button class="btn btn-sm btn-outline-primary action-btn" onclick="viewDetails('${app._id}')">
                        View Details
                     </button>
                  </td>
               </tr>
            `;
            tbody.append(row);
         });
      }

      function updateStats(applications) {
         $('#totalCount').text(applications.length);
         $('#pendingCount').text(applications.filter(a => a.applicationStatus === 'pending').length);
         $('#approvedCount').text(applications.filter(a => a.applicationStatus === 'approved').length);
         $('#rejectedCount').text(applications.filter(a => a.applicationStatus === 'rejected').length);
      }

      async function viewDetails(id) {
         currentApplicationId = id;
         try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/citizens/${id}`, {
               headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            
            if (response.ok) {
               const app = data.data;
               const userName = app.user ? app.user.fullName : 'Unknown/Deleted';
               const userEmail = app.user ? app.user.email : 'N/A';

               const renderDocLink = (url, name) => {
                  if (!url) return '';
                  return `
                     <div class="doc-card mb-2" style="background: white; border: 1px solid #e3e6f0; border-radius: 12px; padding: 12px; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between;">
                        <div class="d-flex align-items-center">
                           <div style="width: 44px; height: 44px; background: #f0f7ff; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                              <i class="bi bi-file-earmark-pdf text-primary" style="font-size: 20px;"></i>
                           </div>
                           <div>
                              <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">${name}</div>
                              <div style="font-size: 0.75rem; color: #64748b;">Official Document (PDF)</div>
                           </div>
                        </div>
                        <a href="${url}" target="_blank" class="btn btn-sm btn-primary" style="padding: 6px 16px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; text-decoration: none;">
                           <i class="bi bi-eye me-1"></i>View
                        </a>
                     </div>
                  `;
               };

               const modalBody = `
                  <div class="row g-3">
                     <!-- Left Column: Personal Info Card -->
                     <div class="col-md-5">
                        <div class="card border-0 shadow-sm h-100">
                           <div class="card-body text-center">
                              <div class="mb-3 mt-2">
                                 <img src="${app.photo || '../../images/default-avatar.png'}" 
                                      alt="Photo" 
                                      class="rounded-circle shadow" 
                                      style="width: 100px; height: 100px; object-fit: cover; border: 4px solid #e7f1ff;">
                              </div>
                              <h5 class="card-title mb-1" style="color: #2c3e50; font-weight: 600;">${userName}</h5>
                              <span class="badge bg-primary bg-gradient mb-3" style="padding: 6px 12px;">${app.occupation}</span>
                              
                              <div class="text-start mt-4">
                                 <h6 class="text-uppercase" style="font-size: 11px; color: #7f8c8d; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 12px;">Contact Information</h6>
                                 <div class="mb-2">
                                    <i class="bi bi-envelope-fill text-primary me-2"></i>
                                    <span style="font-size: 14px; color: #2c3e50;">${userEmail}</span>
                                 </div>
                                 <div class="mb-3">
                                    <i class="bi bi-telephone-fill text-primary me-2"></i>
                                    <span style="font-size: 14px; color: #2c3e50;">${app.phoneNumber}</span>
                                 </div>
                                 
                                 <h6 class="text-uppercase" style="font-size: 11px; color: #7f8c8d; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 12px; margin-top: 20px;">Address</h6>
                                 <div class="mb-2">
                                    <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                                    <span style="font-size: 14px; color: #2c3e50;">${app.address}</span>
                                 </div>
                                 
                                 <h6 class="text-uppercase" style="font-size: 11px; color: #7f8c8d; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 12px; margin-top: 20px;">Application Status</h6>
                                 <span class="badge bg-${app.applicationStatus === 'approved' ? 'success' : app.applicationStatus === 'rejected' ? 'danger' : 'warning'} w-100" style="padding: 8px; font-size: 13px;">
                                    ${app.applicationStatus.toUpperCase()}
                                 </span>
                              </div>
                           </div>
                        </div>
                     </div>
                     
                     <!-- Right Column: Documents Card -->
                     <div class="col-md-7">
                        <div class="card border-0 shadow-sm h-100">
                           <div class="card-body">
                              <h6 class="card-title mb-3" style="color: #2c3e50; font-weight: 600;">
                                 <i class="bi bi-folder2-open me-2 text-primary"></i>Uploaded Documents
                              </h6>
                              
                              <div class="documents-list">
                                 ${renderDocLink(app.birthCertificate, 'Birth Certificate')}
                                 ${renderDocLink(app.proofOfAddress, 'Proof of Address')}
                                 ${app.educationalCert ? renderDocLink(app.educationalCert, 'Educational Certificate') : ''}
                                 
                                 ${app.additionalDocs && app.additionalDocs.length > 0 ? 
                                    '<h6 class="card-title mt-4 mb-3" style="color: #2c3e50; font-weight: 600;"><i class="bi bi-file-earmark-plus me-2 text-primary"></i>Additional Documents</h6>' +
                                    app.additionalDocs.map((doc, idx) => renderDocLink(doc, `Additional Document ${idx + 1}`)).join('') 
                                    : ''
                                 }
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               `;
               $('#modalBody').html(modalBody);
               
               if (app.applicationStatus === 'pending') {
                  $('#approveBtn, #rejectBtn').show();
               } else {
                  $('#approveBtn, #rejectBtn').hide();
               }
               
               new bootstrap.Modal(document.getElementById('detailsModal')).show();
            }
         } catch (error) {
            console.error('Error:', error);
         }
      }

      async function updateStatus(id, status) {
         try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/citizens/${id}/status`, {
               method: 'PATCH',
               headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
               },
               body: JSON.stringify({ status })
            });
            
            if (response.ok) {
               bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
               loadApplications();
               alert(`Application ${status} successfully`);
            } else {
               alert('Failed to update status');
            }
         } catch (error) {
            console.error('Error:', error);
         }
      }

      async function approveWithNID(id) {
         try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/citizens/${id}/approve`, {
               method: 'PUT',
               headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
               }
            });
            
            const data = await response.json();
            if (response.ok) {
               bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
               loadApplications();
               alert(`âœ“ Citizen approved successfully!\n\nNID Generated: ${data.data.nidNumber}\n\nA professional NID document has been created.`);
            } else {
               alert('Failed to approve: ' + (data.message || 'Unknown error'));
            }
         } catch (error) {
            console.error('Approve error:', error);
            alert('Error approving citizen');
         }
      }

      // Search citizens
      async function searchCitizens() {
         const searchTerm = document.getElementById('searchInput').value.trim();
         if (!searchTerm) {
            loadApplications();
            return;
         }

         try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/citizens/search?nid=${searchTerm}&firstName=${searchTerm}&email=${searchTerm}&phone=${searchTerm}`, {
               headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            if (response.ok && data.success) {
               renderTable(data.data);
               updateStats(data.data);
            }
         } catch (error) {
            console.error('Search error:', error);
         }
      }

      let searchTimeout;
      function debounceSearch() {
         clearTimeout(searchTimeout);
         searchTimeout = setTimeout(searchCitizens, 300);
      }

      function clearSearch() {
         document.getElementById('searchInput').value = '';
         loadApplications();
      }

      // Enter key search
      document.addEventListener('DOMContentLoaded', function() {
         document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCitizens();
         });
      });
   </script>
</body>
</html>
